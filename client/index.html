<head>
  <style>
    body, html {
      background-color: #fff;
      margin: 0;
    }
    .app-container {
      font-family: Arial, Helvetica, sans-serif;
      margin: 10px;
      padding: 5px;
    }
    
    .api {
      border: 1px solid black;
      margin: 5px;
    }

    .api a {
      color: #444499;
      text-decoration: none;
      margin: 10px;
      display: block
    }
    
    h2 {
      font-size: 1.2em
    }
  </style>
</head>
<div class="app-container">
  <h1>Test APIs</h1>
</div>
<script>
  (function () {
    const host = "lit-waters-25881.herokuapp.com"
    // API List
    const timer = {
      subs: {},
      on: function(name, cb) {
        if (this.subs[name]) {
          this.subs[name].push(cb)
        } else {
          this.subs[name] = [cb]
        }

        return function() {
          this.subs[name].splice(this.subs[name].indexOf(cb))
        }
      },
      update: function(time) {
        if (this.subs.update) {
          this.subs.update.forEach(cb => cb(time))
        }
      }
    }

    fetch('http://' + host + '/config')
      .then(res => {
        res.json()
          .then(data => {
            data.forEach(api => {
              const container = document.createElement('div')
              const endpoint = document.createElement('a')
              const name = document.createElement('h2')
              const timeBar = document.createElement('div')

              container.className = 'api'

              container.style.width = "100%";
              timeBar.style.width = "100%";
              timeBar.style.height = '4px'
              
              timeBar.style.backgroundColor = 'black'

              name.innerHTML = api.name
              
              endpoint.href = api.endpoint

              document.querySelector('.app-container').appendChild(container)
              endpoint.appendChild(name)
              container.appendChild(endpoint)
              container.appendChild(timeBar)

              timer.on('update', function(time) {
                 let timeRemaining = api.interval - time % api.interval
                 let progress = (timeRemaining / api.interval) * 100
                 let isUp = Math.floor(time / api.interval) % 2 === 0

                 timeBar.style.width = progress + "%"
                 container.style.backgroundColor = isUp ? '#99ff99' : '#ff9999'
              })
            })
          })
      })

    // WebSocket
    const socket = new WebSocket('ws://' + host)

    socket.addEventListener('open', function (event) {
      console.log('Connected')
    })
    socket.addEventListener('message', function (event) {
      if (event.data) {
        timer.update(Number.parseFloat(event.data))
      }
    })
  })()
</script>